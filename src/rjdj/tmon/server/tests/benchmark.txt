##############################################################################
#
# Copyright (c) 2011 Reality Jockey Ltd. and Contributors.
# This file is part of T-Mon.
#
# T-Mon is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# T-Mon is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with T-Mon. If not, see <http://www.gnu.org/licenses/>.
#
##############################################################################

=====================================
$ Benchmarking
=====================================
    >>> import base64
    >>> import hashlib
    >>> import time
    >>> import json
    >>> import hmac
    >>> from rjdj.tmon.server.models import WebService
    >>> from django.contrib.auth.models import User 
    >>> from Crypto.Cipher import AES
    >>> from pprint import pprint
    >>> from rjdj.djangotornado.testing import TestClient as Client
    >>> from rjdj.tmon.server.urls import tornado_urls
    >>> from pprint import pprint
    >>> RUNS = 150

Preparations:
-------------
    >>> c = Client(tornado_urls)
    >>> TEST_URL = "/data/collect"
    >>> TEST_SECRET = "A" * 32

    >>> user = User()
    >>> user.username = "another_testuser"
    >>> user.set_password("!test")
    >>> user.email = "test@test.com"
    >>> user.save()

    >>> ws = WebService()    
    >>> ws.owner = user
    >>> ws.secret = TEST_SECRET
    >>> ws.name = "_".join(("testdb", hashlib.md5(str(time.time())).hexdigest()))
    >>> ws.save()


Helper functions:
----------------
    >>> def sign(packet, secret=TEST_SECRET):
    ...     signature = hmac.new(secret, packet,
    ...                          hashlib.sha1).hexdigest()
    ...     return signature

    >>> def make_package(data, wsid):
    ...     payload = json.dumps(data)
    ...     encoded_payload = base64.b64encode(payload)
    ...     return  { "data" : encoded_payload, "wsid" : wsid, "signature": sign(payload) }
    
    >>> def make_package_enc(data, wsid):
    ...     payload = AES.new(TEST_SECRET, AES.MODE_CFB).encrypt(json.dumps(data))
    ...     encoded_payload = base64.b64encode(payload)
    ...     return  { "data" : encoded_payload, "wsid" : wsid }
    
    
Benchmarking!
-------------
    >>> request = { 
    ...         "ip": "72.32.231.8",
    ...         "useragent": "Mozilla/5.0 (iPad; U; CPU OS 3_2_1 like Mac)",
    ...         "url": "/" }
    >>> from django.conf import settings
    >>> settings.DEBUG = False
    >>> pkg = make_package(request, ws.id)    
    >>> for r in xrange(RUNS):
    ...     x = c.post(TEST_URL, pkg)

Verification:
-------------

    >>> from rjdj.tmon.server.utils.connection import connection
    >>> db = connection.database(ws.name)
    >>> for id in db:
    ...     if not id.startswith("_"):
    ...         e = db[id]
    ...         assert e["ip"] == request["ip"]
    ...         assert e["useragent"] == request["useragent"]
    ...         assert e["url"] == request["url"]
    >>> assert len(db) == RUNS + 4
    
    
    
    
    
    
    
    
    
    
    
